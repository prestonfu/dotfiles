%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% prestonfu.sty - Copyright Preston Fu 2020       %
% Credit to Evan Chen                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesPackage{prestonfu}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%          OPTIONS          %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifprestonmdthm\prestonmdthmfalse
\newif\ifprestoncolor\prestoncolortrue
\newif\ifprestonmonochrome\prestonmonochromefalse
\newif\ifprestonchthm\prestonchthmfalse
\newif\ifprestonsecthm\prestonsecthmtrue
\newif\ifprestonfancy\prestonfancytrue
\newif\ifprestonplainhdr\prestonplainhdrfalse
\newif\ifprestonqednow\prestonqednowfalse
\newif\ifprestonpazo\prestonpazofalse
\newif\ifprestonroboto\prestonrobotofalse
\newif\ifprestonsetlinespacing\prestonsetlinespacingtrue
\newif\ifprestonnoindent\prestonnoindentfalse
\newif\ifprestonmarginset\prestonmarginsettrue
\newif\ifprestonboldenum\prestonboldenumfalse
\newif\ifprestonindex\prestonindexfalse

\DeclareOption{mdthm}{\prestonmdthmtrue}
\DeclareOption{nomdthm}{\prestonmdthmfalse}
\DeclareOption{color}{\prestoncolortrue}
\DeclareOption{nocolor}{\prestoncolorfalse}
\DeclareOption{monochrome}{\prestoncolorfalse\prestonmonochrometrue}

\DeclareOption{chthm}{\prestonchthmtrue}
\DeclareOption{secthm}{\prestonsecthmtrue}
\DeclareOption{nosecthm}{\prestonsecthmfalse}

\DeclareOption{fancy}{\prestonfancytrue}
\DeclareOption{plainhdr}{\prestonplainhdrtrue}
\DeclareOption{nofancy}{\prestonfancyfalse}
\DeclareOption{qednow}{\prestonqednowtrue}
\DeclareOption{pazo}{\prestonpazotrue}
\DeclareOption{roboto}{\prestonrobototrue}
\DeclareOption{noindent}{\prestonnoindenttrue}
\DeclareOption{nomarginset}{\prestonmarginsetfalse}
\DeclareOption{boldenum}{\prestonboldenumtrue}
\DeclareOption{index}{\prestonindextrue}

\DeclareOption{amsart}{
    \prestoncolorfalse
    \prestonfancyfalse
}

\@ifundefined{KOMAClassName}{
    \newcommand{\headingfont}{\bfseries}
    \newcommand{\sansfont}{\normalfont}
}{
    \prestonmdthmtrue
    \prestonboldenumtrue
    \newcommand{\headingfont}{\sffamily\bfseries}
    \newcommand{\sansfont}{\sffamily}
}

\ProcessOptions\relax

\usepackage[utf8]{inputenc}
\usepackage{amsmath,amsfonts,amssymb}
\usepackage{amsthm}
\usepackage{thmtools}
\PassOptionsToPackage{usenames,svgnames,dvipsnames}{xcolor}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage{mathdots}
\usepackage[final]{pdfpages}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{enumitem}
\usepackage{mathtools}
\usepackage{epigraph}
\usepackage{hyperref}
\usepackage{mathrsfs}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usepackage{appendix}
\usepackage{imakeidx}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%      USEFUL COMMANDS      %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\dotp}{\boldsymbol{\cdot}}
\newcommand{\x}{\times}
\newcommand{\cbrt}[1]{\sqrt[3]{#1}}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\ceil}[1]{\left\lceil #1 \right\rceil}
\newcommand{\braces}[1]{\left \{ #1 \right \}}
\newcommand{\set}[1]{\left \{ #1 \right \}}
\newcommand{\parens}[1]{\left( #1 \right)}
\newcommand{\brackets}[1]{\left[ #1 \right]}
\newcommand{\angleb}[1]{\left\langle #1 \right\rangle}
\newcommand{\pfrac}[2]{\parens{\frac{#1}{#2}}}
\newcommand{\mailto}[1]{\href{mailto:#1}{\texttt{#1}}}
\newcommand{\ol}{\overline}
\newcommand{\ul}{\underline}
\newcommand{\eps}{\varepsilon}
\renewcommand{\deg}{^\circ}
\renewcommand{\bold}[1]{{\boldmath\bfseries #1}}
\ifprestoncolor
    \newcommand{\vocab}[1]{\bold{\color{MidnightBlue} #1}}
\else
    \newcommand{\vocab}[1]{\bold{#1}}
\fi
\newcommand{\hrulebar}{\begin{center}\nointerlineskip\vspace{5pt}\rule{\textwidth}{.7pt}\hspace{\fill}\end{center}}
\newcommand{\ans}[5]{\textbf{(A) }#1\qquad\textbf{(B) }#2\qquad\textbf{(C) }#3\qquad\textbf{(D) }#4\qquad\textbf{(E) }#5}

% Topology
\newcommand{\id}{\mathrm{id}}
\newcommand{\inv}{^{-1}}

% Functions
\DeclareMathOperator*{\lcm}{lcm} % least common multiple
\DeclareMathOperator*{\re}{Re} % real part
\DeclareMathOperator*{\im}{Im} % imaginary part
\DeclareMathOperator*{\pow}{Pow} % power
\DeclareMathOperator*{\diam}{diam} % diameter
\DeclareMathOperator*{\mesh}{mesh} % mesh
\DeclareMathOperator*{\ord}{ord} % order
\DeclareMathOperator*{\adj}{adj} % adjugate
\DeclareMathOperator*{\cur}{curl} % curl
\DeclareMathOperator*{\die}{div} % divergence
\DeclareMathOperator*{\cis}{cis} % cis
\DeclareMathOperator*{\rank}{rank} % rank
\DeclareMathOperator*{\Spec}{Spec} % spectrum
\DeclareMathOperator*{\Tr}{Tr} % trace
\DeclareMathOperator*{\Dom}{Dom} % domain
\DeclareMathOperator*{\Rng}{Rng} % range

% Sums and Products
\newcommand{\cycsum}{\sum_{\mathrm{cyc}}}
\newcommand{\symsum}{\sum_{\mathrm{sym}}}
\newcommand{\cycprod}{\prod_{\mathrm{cyc}}}
\newcommand{\symprod}{\prod_{\mathrm{sym}}}

% Letters
\newcommand{\CC}{\mathbb C}
\newcommand{\EE}{\mathbb E}
\newcommand{\FF}{\mathbb F}
\newcommand{\HH}{\mathbb H}
\newcommand{\NN}{\mathbb N}
\newcommand{\PP}{\mathbb P}
\newcommand{\QQ}{\mathbb Q}
\newcommand{\TT}{\mathbb T}
\newcommand{\RR}{\mathbb R}
\newcommand{\UU}{\mathbb U}
\newcommand{\ZZ}{\mathbb Z}
\newcommand{\Qbar}{\overline{\QQ}}
\newcommand{\Zbar}{\overline{\ZZ}}
\newcommand{\ii}{\mathbf i}
\newcommand{\jj}{\mathbf j}
\newcommand{\kk}{\mathbf k}

\newcommand{\mfb}{\mathfrak b}
\newcommand{\mfg}{\mathfrak g}
\newcommand{\mfh}{\mathfrak h}
\newcommand{\mfm}{\mathfrak m}
\newcommand{\mfn}{\mathfrak n}
\newcommand{\mfp}{\mathfrak p}
\newcommand{\mfq}{\mathfrak q}
\newcommand{\mfu}{\mathfrak u}
\newcommand{\mfz}{\mathfrak z}

\newcommand{\mcA}{\mathcal A} 
\newcommand{\mcB}{\mathcal B} 
\newcommand{\mcC}{\mathcal C} 
\newcommand{\mcD}{\mathcal D} 
\newcommand{\mcE}{\mathcal E} 
\newcommand{\mcF}{\mathcal F} 
\newcommand{\mcG}{\mathcal G} 
\newcommand{\mcH}{\mathcal H} 
\newcommand{\mcI}{\mathcal I} 
\newcommand{\mcJ}{\mathcal J} 
\newcommand{\mcK}{\mathcal K} 
\newcommand{\mcL}{\mathcal L} 
\newcommand{\mcM}{\mathcal M} 
\newcommand{\mcN}{\mathcal N} 
\newcommand{\mcO}{\mathcal O} 
\newcommand{\mcP}{\mathcal P} 
\newcommand{\mcQ}{\mathcal Q} 
\newcommand{\mcR}{\mathcal R} 
\newcommand{\mcS}{\mathcal S} 
\newcommand{\mcT}{\mathcal T} 
\newcommand{\mcU}{\mathcal U} 
\newcommand{\mcV}{\mathcal V} 
\newcommand{\mcW}{\mathcal W} 
\newcommand{\mcX}{\mathcal X} 
\newcommand{\mcY}{\mathcal Y} 
\newcommand{\mcZ}{\mathcal Z}

\newcommand{\msA}{\mathscr A} 
\newcommand{\msB}{\mathscr B} 
\newcommand{\msC}{\mathscr C} 
\newcommand{\msD}{\mathscr D} 
\newcommand{\msE}{\mathscr E} 
\newcommand{\msF}{\mathscr F} 
\newcommand{\msG}{\mathscr G} 
\newcommand{\msH}{\mathscr H} 
\newcommand{\msI}{\mathscr I} 
\newcommand{\msJ}{\mathscr J} 
\newcommand{\msK}{\mathscr K} 
\newcommand{\msL}{\mathscr L} 
\newcommand{\msM}{\mathscr M} 
\newcommand{\msN}{\mathscr N} 
\newcommand{\msO}{\mathscr O} 
\newcommand{\msP}{\mathscr P} 
\newcommand{\msQ}{\mathscr Q} 
\newcommand{\msR}{\mathscr R} 
\newcommand{\msS}{\mathscr S} 
\newcommand{\msT}{\mathscr T} 
\newcommand{\msU}{\mathscr U} 
\newcommand{\msV}{\mathscr V} 
\newcommand{\msW}{\mathscr W} 
\newcommand{\msX}{\mathscr X} 
\newcommand{\msY}{\mathscr Y} 
\newcommand{\msZ}{\mathscr Z}

% Geometry
\newcommand{\abs}[1]{\left\lvert #1 \right\rvert}
\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}
\newcommand{\dang}{\measuredangle}
\newcommand{\ray}[1]{\overrightarrow{#1}} 
\newcommand{\seg}[1]{\overline{#1}}
\DeclareSymbolFont{yhlargesymbols}{OMX}{yhex}{m}{n}
\DeclareMathAccent{\wideparen}{\mathord}{yhlargesymbols}{"F3}
\newcommand{\arc}[1]{\wideparen{#1}}

% Custom enumerates
\newenvironment{anum}{ % (a), (b), ...
\begin{enumerate}[label = (\alph*)]}{\end{enumerate}}
\newenvironment{Rnum}{ % (I), (II), ...
\begin{enumerate}[label = (\Roman*)]}{\end{enumerate}}
\newenvironment{rnum}{ % (i), (ii), ...
\begin{enumerate}[label = (\roman*)]}{\end{enumerate}}

\newenvironment{myenum} % no space
{ \begin{enumerate}[topsep = 0pt]
    \setlength{\topsep}{0pt}
    \setlength{\itemsep}{0pt}
    \setlength{\parskip}{0pt}
    \setlength{\parsep}{0pt}     }
{ \end{enumerate}                  }

\newenvironment{myitem} % no space
{ \begin{itemize}[topsep = 0pt]
    \setlength{\itemsep}{0pt}
    \setlength{\parskip}{0pt}
    \setlength{\parsep}{0pt}     }
{ \end{itemize}                  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%         HYPERREF          %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{astral}{RGB}{46,116,181}
\ifprestoncolor
    \hypersetup{
        colorlinks,
        citecolor=astral,
        filecolor=astral,
        linkcolor=astral,
        urlcolor=astral
    }
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%            PAGE SETUP            %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifprestonsetlinespacing
    \ifprestonnoindent
        \setlength{\parindent}{0pt}
        \setlength{\parskip}{0.3ex}
    \fi
    \renewcommand{\baselinestretch}{1.05}
\fi
\ifprestonmarginset
    \usepackage[margin=1in]{geometry}
\fi
\ifprestonpazo \usepackage{mathpazo} \fi
\@ifundefined{KOMAClassName}{}
{
    \ifprestonroboto
        \usepackage{roboto}
    \else
        \usepackage{lmodern}
    \fi
    \ifprestoncolor
        \addtokomafont{section}{\headingfont\color{MidnightBlue}}
        \addtokomafont{subsection}{\headingfont\color{MidnightBlue}}
        \addtokomafont{subsubsection}{\headingfont\color{MidnightBlue}}
        \renewcommand*{\@seccntformat}[1]{\headingfont\color{MidnightBlue}{\sffamily\S}\csname the#1\endcsname\quad}
    \else
        \addtokomafont{section}{\headingfont}
        \addtokomafont{subsection}{\headingfont}
        \addtokomafont{subsubsection}{\headingfont}
        \renewcommand*{\@seccntformat}[1]{\headingfont{\sffamily\S}\csname the#1\endcsname\quad}
    \fi
}
\ifprestonindex \makeindex[columns=2,intoc] \fi
\ifprestonboldenum \setlist[enumerate]{font=\bfseries} \fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%          THEOREMS         %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifprestonmdthm
    \ifprestoncolor
        \mdfdefinestyle{mdbluebox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=MidnightBlue,
    		backgroundcolor=TealBlue!5,
    	}
    
    	\declaretheoremstyle[
    		headfont=\headingfont\color{MidnightBlue},
    		bodyfont=\itshape,
    		mdframed={style=mdbluebox},
    		headpunct={. },
    		postheadspace={0pt}
    	]{thmbluebox}
    	
    	\mdfdefinestyle{mdgreenbox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=ForestGreen,
    		backgroundcolor=ForestGreen!5,
    	}
    
    	\declaretheoremstyle[
    		headfont=\headingfont\color{ForestGreen},
    		mdframed={style=mdgreenbox},
    		headpunct={. },
    		postheadspace={0pt},
    	]{thmgreenbox}
    	
    	\mdfdefinestyle{mdorangebox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=orange,
    		backgroundcolor=Crimson!5,
    	}
    
    	\declaretheoremstyle[
    		headfont=\headingfont\color{orange},
    		mdframed={style=mdorangebox},
    		headpunct={. },
    		postheadspace={0pt},
    	]{thmorangebox}
    	
    	\mdfdefinestyle{mdredbox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=RawSienna,
    		backgroundcolor=Salmon!5,
    	}
    
    	\declaretheoremstyle[
    		headfont=\headingfont\color{RawSienna},
    		mdframed={style=mdredbox},
    		headpunct={. },
    		postheadspace={0pt},
    	]{thmredbox}
    	
    	\mdfdefinestyle{mdblackbox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=black,
    		backgroundcolor=RedViolet!5!gray!5,
    	}
    
    	\declaretheoremstyle[
    		headfont=\itshape\sansfont,
    		mdframed={style=mdblackbox},
    		headpunct={. },
    		postheadspace={0pt},
    	]{thmblackbox}
    	
    	\mdfdefinestyle{mdpurplebox}{%
    		skipabove=8pt,
    		linewidth=3pt,
    		rightline=false,
    		leftline=true,
    		topline=false,
    		bottomline=false,
    		linecolor=RoyalPurple,
    		backgroundcolor=Orchid!4,
    	}
    
    	\declaretheoremstyle[
    		headfont=\headingfont\color{RoyalPurple},
    		mdframed={style=mdpurplebox},
    		headpunct={. },
    		postheadspace={0pt},
    	]{thmpurplebox}
    	
    \else
        \ifprestonmonochrome
            \mdfdefinestyle{mdbluebox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=RoyalBlue!30!Gray!40,
        	}
        
        	\declaretheoremstyle[
        		headfont=\headingfont,
        		bodyfont=\itshape,
        		mdframed={style=mdbluebox},
        		headpunct={. },
        		postheadspace={0pt}
        	]{thmbluebox}
        	
        	\mdfdefinestyle{mdgreenbox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=Cerulean!20!Gray!40,
        	}
        
        	\declaretheoremstyle[
        		headfont=\headingfont,
        		mdframed={style=mdgreenbox},
        		headpunct={. },
        		postheadspace={0pt},
        	]{thmgreenbox}
        	
        	\mdfdefinestyle{mdorangebox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=RoyalBlue!20!Gray!30,
        	}
        
        	\declaretheoremstyle[
        		headfont=\headingfont,
        		mdframed={style=mdorangebox},
        		headpunct={. },
        		postheadspace={0pt},
        	]{thmorangebox}
        	
        	\mdfdefinestyle{mdredbox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=Cerulean!20!Gray!40,
        	}
        
        	\declaretheoremstyle[
        		headfont=\headingfont,
        		mdframed={style=mdredbox},
        		headpunct={. },
        		postheadspace={0pt},
        	]{thmredbox}
        	
        	\mdfdefinestyle{mdblackbox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=Cerulean!10!Gray!40,
        	}
        
        	\declaretheoremstyle[
        		headfont=\itshape\sansfont,
        		mdframed={style=mdblackbox},
        		headpunct={. },
        		postheadspace={0pt},
        	]{thmblackbox}
        	
        	\mdfdefinestyle{mdpurplebox}{%
        		skipabove=8pt,
        		linewidth=0.5pt,
        		backgroundcolor=MidnightBlue!10!Gray!35,
        	}
        
        	\declaretheoremstyle[
        		headfont=\headingfont,
        		mdframed={style=mdpurplebox},
        		headpunct={. },
        		postheadspace={0pt},
        	]{thmpurplebox}
        \fi
    \fi
    	
	\mdfdefinestyle{mdgraybox}{%
		skipabove=8pt,
		linewidth=0.5pt,
		backgroundcolor=Gray!20,
	}

	\declaretheoremstyle[
		headfont=\headingfont,
		mdframed={style=mdgraybox},
		headpunct={. },
		postheadspace={0pt},
	]{thmgraybox}
    
	\mdfdefinestyle{mdbox}{%
		skipabove=8pt,
		linewidth=0.5pt
	}
	\declaretheoremstyle[
		headfont=\headingfont,
		mdframed={style=mdbox},
		headpunct={. },
		postheadspace={0pt},
	]{thmbox}
\fi

\newcommand{\listhack}{$\empty$\vspace{-2em}}

\ifprestonmdthm
    \if\ifprestoncolor T\else\ifprestonmonochrome T\else F\fi\fi T%
        \theoremstyle{plain} % Theorem, Lemma, Proposition, Corollary
        
        \ifprestonchthm
            \declaretheorem[style=thmbluebox,name=Theorem,numberwithin=chapter]{thm}
    	\else
        	\ifprestonsecthm
        		\declaretheorem[style=thmbluebox,name=Theorem,numberwithin=section]{thm}
        	\else
        		\declaretheorem[style=thmbluebox,name=Theorem]{thm}
        	\fi
    	\fi
    	\declaretheorem[style=thmbluebox,name=Lemma,sibling=thm]{lemma}
    	\declaretheorem[style=thmbluebox,name=Proposition,sibling=thm]{prop}
    	\declaretheorem[style=thmbluebox,name=Corollary,sibling=thm]{cor}
    	
        \declaretheorem[style=thmbluebox,name=Theorem,numbered=no]{thm*}
    	\declaretheorem[style=thmbluebox,name=Lemma,numbered=no]{lemma*}
    	\declaretheorem[style=thmbluebox,name=Proposition,numbered=no]{prop*}
    	\declaretheorem[style=thmbluebox,name=Corollary,numbered=no]{cor*}
    	
        \theoremstyle{definition} % Problem, example, definition, claim,
        % definition, conjecture, fact, question, answer, notation,
        % terminology, upshot, warning, bogus, boxed solution
    
        \ifprestonchthm
            \declaretheorem[name=Problem,numberwithin=chapter]{prob}
            \declaretheorem[style=thmredbox,name=Example,numberwithin=chapter]{ex}
        \else
            \ifprestonsecthm
            	\declaretheorem[name=Problem,numberwithin=section]{prob}
            	\declaretheorem[style=thmredbox,name=Example,numberwithin=section]{ex}
            \else
                \declaretheorem[name=Problem]{prob}
                \declaretheorem[style=thmredbox,name=Example]{ex}
            \fi
        \fi
        \declaretheorem[name=Problem,numbered=no]{prob*}
        \declaretheorem[style=thmredbox,name=Example,numbered=no]{ex*}
        
    	\declaretheorem[style=thmgreenbox,name=Problem,sibling=prob]{boxprob}
    	\declaretheorem[style=thmorangebox,name=Claim,sibling=thm]{claim}
    	\declaretheorem[style=thmgreenbox,name=Problem,numbered=no]{boxprob*}
    	\declaretheorem[style=thmorangebox,name=Claim,numbered=no]{claim*}
    	\declaretheorem[style=thmpurplebox,name=Warning,numbered=no]{warn}
    	
        \declaretheorem[style=thmpurplebox,name=Bogus Solution,numbered=no]{bogussol}
        \declaretheorem[style=thmpurplebox,name=Bogus Proof,numbered=no]{boguspf}
        \declaretheorem[style=thmgraybox,name=Solution,numbered=no]{boxsol}
        \declaretheorem[style=thmgraybox,name=Proof,numbered=no]{boxpf}
    	
    	\theoremstyle{remark}
    	\declaretheorem[style=thmblackbox,name=Remark,numbered=no]{remark}
    \else
        \theoremstyle{plain} % Theorem, Lemma, Proposition, Corollary
        
        \ifprestonchthm
            \declaretheorem[style=thmbox,name=Theorem,numberwithin=chapter]{thm}
    	\else
        	\ifprestonsecthm
        		\declaretheorem[style=thmbox,name=Theorem,numberwithin=section]{thm}
        	\else
        		\declaretheorem[style=thmbox,name=Theorem]{thm}
        	\fi
    	\fi
    	\declaretheorem[style=thmbox,name=Lemma,sibling=thm]{lemma}
    	\declaretheorem[style=thmbox,name=Proposition,sibling=thm]{prop}
    	\declaretheorem[style=thmbox,name=Corollary,sibling=thm]{cor}
    	
        \declaretheorem[style=thmbox,name=Theorem,numbered=no]{thm*}
    	\declaretheorem[style=thmbox,name=Lemma,numbered=no]{lemma*}
    	\declaretheorem[style=thmbox,name=Proposition,numbered=no]{prop*}
    	\declaretheorem[style=thmbox,name=Corollary,numbered=no]{cor*}
    	
        \theoremstyle{definition} % Problem, example, definition, claim,
        % definition, conjecture, fact, question, answer, notation,
        % terminology, upshot, warning, bogus, boxed solution
    
        \ifprestonchthm
            \declaretheorem[name=Problem,numberwithin=chapter]{prob}
            \declaretheorem[style=thmbox,name=Example,numberwithin=chapter]{ex}
        \else
            \ifprestonsecthm
            	\declaretheorem[name=Problem,numberwithin=section]{prob}
            	\declaretheorem[style=thmbox,name=Example,numberwithin=section]{ex}
            \else
                \declaretheorem[name=Problem]{prob}
                \declaretheorem[style=thmbox,name=Example]{ex}
            \fi
        \fi
        \declaretheorem[name=Problem,numbered=no]{prob*}
        \declaretheorem[style=thmbox,name=Example,numbered=no]{ex*}
        
    	\declaretheorem[style=thmbox,name=Problem,sibling=prob]{boxprob}
    	\declaretheorem[style=thmbox,name=Claim,sibling=thm]{claim}
    	\declaretheorem[style=thmbox,name=Problem,numbered=no]{boxprob*}
    	\declaretheorem[style=thmbox,name=Claim,numbered=no]{claim*}
    	\declaretheorem[style=thmbox,name=Warning,numbered=no]{warn}
    	
        \declaretheorem[style=thmbox,name=Bogus Solution,numbered=no]{bogussol}
        \declaretheorem[style=thmbox,name=Bogus Proof,numbered=no]{boguspf}
        \declaretheorem[style=thmbox,name=Solution,numbered=no]{boxsol}
        \declaretheorem[style=thmbox,name=Proof,numbered=no]{boxpf}
    	
    	\theoremstyle{remark}
    	\declaretheorem[style=thmbox,name=Remark,numbered=no]{remark}
    \fi
\else
    \theoremstyle{plain} % Theorem, Lemma, Proposition, Corollary
    
    \ifprestonchthm
        \declaretheorem[name=Theorem,numberwithin=chapter]{thm}
	\else
    	\ifprestonsecthm
    		\declaretheorem[name=Theorem,numberwithin=section]{thm}
    	\else
    		\declaretheorem[name=Theorem]{thm}
    	\fi
	\fi
	\declaretheorem[name=Lemma,sibling=thm]{lemma}
	\declaretheorem[name=Proposition,sibling=thm]{prop}
	\declaretheorem[name=Corollary,sibling=thm]{cor}
	
	\declaretheorem[name=Theorem,numbered=no]{thm*}
	\declaretheorem[name=Lemma,numbered=no]{lemma*}
	\declaretheorem[name=Proposition,numbered=no]{prop*}
	\declaretheorem[name=Corollary,numbered=no]{cor*}
	
	\theoremstyle{definition} % Problem, example, definition, claim,
    % definition, conjecture, fact, question, answer, notation,
    % terminology, upshot, warning
    
    \ifprestonchthm
        \declaretheorem[name=Problem,numberwithin=chapter]{prob}
        \declaretheorem[name=Example,numberwithin=chapter]{ex}
    \else
        \ifprestonsecthm
        	\declaretheorem[name=Problem,numberwithin=section]{prob}
        	\declaretheorem[name=Example,numberwithin=section]{ex}
        \else
            \declaretheorem[name=Problem]{prob}
            \declaretheorem[name=Example]{ex}
        \fi
    \fi
    \declaretheorem[name=Problem,numbered=no]{prob*}
    \declaretheorem[name=Example,numbered=no]{ex*}
    
	\declaretheorem[name=Claim,sibling=thm]{claim}
	\declaretheorem[name=Claim,numbered=no]{claim*}
	\declaretheorem[name=Warning,numbered=no]{warn}
	
	 \newenvironment{bogussol}[1][Bogus Solution] {\par\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\bfseries#1\@addpunct{.}]\ignorespaces}{\endtrivlist\@endpefalse}
    \newenvironment{boguspf}[1][Bogus Proof] {\par\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\bfseries#1\@addpunct{.}]\ignorespaces}{\endtrivlist\@endpefalse}
	
	\theoremstyle{remark}
	\declaretheorem[name=Remark,numbered=no]{remark}
\fi

%% Non-MD-style

\theoremstyle{definition}

\declaretheorem[name=Definition,sibling=thm]{defn}
\declaretheorem[name=Conjugate,sibling=thm]{conj}
\declaretheorem[name=Fact,sibling=thm]{fact}
\declaretheorem[name=Question,sibling=thm]{question}
\declaretheorem[name=Answer,sibling=thm]{answer}

\declaretheorem[name=Definition,numbered=no]{defn*}
\declaretheorem[name=Conjugate,numbered=no]{conj*}
\declaretheorem[name=Fact,numbered=no]{fact*}
\declaretheorem[name=Question,numbered=no]{question*}
\declaretheorem[name=Answer,numbered=no]{answer*}
\declaretheorem[name=Notation,numbered=no]{notation}
\declaretheorem[name=Terminology,numbered=no]{term}
\declaretheorem[name=Upshot,numbered=no]{upshot}
\declaretheorem[name=Exercise,sibling=ex]{exer}
\declaretheorem[name=Exercise,numbered=no]{exer*}

\theoremstyle{remark} % Remark, note

\declaretheorem[name=Note,numbered=no]{note}
\newenvironment{hint}{\scriptsize [Hint:}{\scriptsize\unskip]}
\newcommand{\proofprob}{\begin{note}This is a proof problem. Instead of entering an answer into the boxes below, please attach your proof to this paper.\end{note}}

\renewcommand\qedsymbol{$\blacksquare$}

\ifprestonqednow
\renewenvironment{proof}[1][\proofname]{\par\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\itshape#1\@addpunct{.}]\ignorespaces}{\nolinebreak\qedsymbol\endtrivlist\@endpefalse}
\fi

\newenvironment{subproof}[1][\proofname]{\renewcommand{\qedsymbol}{$\Box$}\begin{proof}[#1]}{\end{proof}}
\newenvironment{sol}[1][Solution] {\par\pushQED{\qed}\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\bfseries#1\@addpunct{.}]\ignorespaces}{\popQED\endtrivlist\@endpefalse}
\newenvironment{solsketch}[1][Solution Sketch] {\par\pushQED{\qed}\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\bfseries#1\@addpunct{.}]\ignorespaces}{\popQED\endtrivlist\@endpefalse}
\newenvironment{pfsketch}[1][Proof Sketch] {\par\pushQED{\qed}\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\bfseries#1\@addpunct{.}]\ignorespaces}{\popQED\endtrivlist\@endpefalse}
\newenvironment{progress}[1][Progress] {\par\normalfont\topsep6\p@\@plus6\p@\relax\trivlist\item[\hskip\labelsep\itshape#1\@addpunct{.}]\ignorespaces}{\endtrivlist\@endpefalse}

%% See above for bogus and boxed solution.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%           CODE            %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
    language=C++,
    aboveskip=3mm,
    belowskip=3mm,
    showstringspaces=false,
    columns=flexible,
    basicstyle={\small\ttfamily},
    numbers=left,
    numbersep=5pt,
    numberstyle=\tiny\color{gray},
    keywordstyle=\color{blue},
    commentstyle=\color{dkgreen},
    stringstyle=\color{mauve},
    breaklines=true,
    breakatwhitespace=true,
    tabsize=4,
    frame=single
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  %%%%         FANCYHDR          %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifprestonfancy
    \usepackage{fancyhdr}
    
    \ifprestonplainhdr
        \pagestyle{fancy}
        \lhead{{\Author} (\Date)}
        \rhead{\Title}
        \setlength{\headheight}{20pt} 
        \setlength{\headsep}{3mm}
    \else
        \pagestyle{fancy}
        \lhead{\small\textbf{\Author}  (\Date)}
        \rhead{\small\textbf{\Title}}
        \setlength{\headheight}{20pt} 
        \setlength{\headsep}{3mm}
    \fi
\fi
